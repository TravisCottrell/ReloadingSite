{% extends "base.html" %}
{% block title%} Single Gun{% endblock title%}


{% comment %} 
  -need to actually rest api create 
  -update the add result to make a new row 
{% endcomment %}
{% block content %}
  <div class="container">
    <nav aria-label="breadcrumb" >
      <ol class="breadcrumb" >
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'guns' %}">Gun List</a></li>
        <li class="breadcrumb-item active">Gun</li>
      </ol>
    </nav>
  </div>

  <div class="container" id="bullet-tables"><br/>
    
      <h1>{{gun.gun}}</h1>
      <div>
        <a class="btn btn-secondary btn-sm" href="{% url 'add_bullet' gun.pk%}">add bullet</a>
      </div><br/>
    
  </div>
{% endblock %}

{% block scripts %}   
<script>

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  //get the bullets and related data for a specified gun and build the bullet tables 
  var dataURL = '/api/gun/{{gun.pk}}/' 
  $.ajax({
          method:'GET',
          url:dataURL,
          success:function(response){
              
              console.log(response)
              for (var gun of response){
                for (var bullet of gun.bullets){
                  addTable(bullet)
                }
              }
          }
  })

  //build a bullet table
  function addTable(bullet){
    var table =  `<div class="card" style="width: 55rem;">
                    <div class="card-body">
                      <div>
                        <h3 class="card-title">${bullet.bullet} </h3>
                        <p>${bullet.powder} </p>
                      </div><br/>
                      <div>
                        <a class="btn btn-secondary btn-sm" href="/gun/edit_bullet/${bullet.pk}/" >Edit Bullet</a>
                      </div><br/>
                      <button class="btn btn-sm btn-primary btn-block" onClick="addResult(${bullet.pk})">add data</button>
                      <table class="table table-bordered table-dark table-hover" >
                       
                        <thead>
                          <tr class="d-flex">
                            <th class="col" scope="col">charge</th>
                            <th class="col" scope="col">1</th>
                            <th class="col" scope="col">2</th>
                            <th class="col" scope="col">3</th>
                            <th class="col" scope="col">MOA</th>
                            <th class="col-3" scope="col"></th>
                          </tr>
                        </thead>
                        <tbody id="bullet-table-${bullet.pk}">
                      
                        </tbody>
                      </table>
                      <a class="btn btn-sm btn-success"  href="/gun/graph/${bullet.pk}/">view graph</a> 
                    </div>
                     
                  </div><br/>
                  `
      
    $('#bullet-tables').append(table)
    for (var result of bullet.results){
      addRow(result, bullet.pk)
    }

    
  }

  function addRow(result, bullet_pk){
    //check if theres any velocity data
    if (result.velocity.length > 0){
      velocityrow = ``
      for(var velocity of result.velocity){
        velocitycol = `<td class="col" id="velocity1-${velocity.pk}" contenteditable="true">${velocity.velocity}</td>`
        velocityrow += velocitycol
      }
    }else{//if theres nothing in the velocity array, print 0's
       velocityrow = `
                    <td class="col" id="velocity1-${result.pk}" contenteditable="true">0</td>
                    <td class="col" id="velocity2-${result.pk}" contenteditable="true">0</td>
                    <td class="col" id="velocity3-${result.pk}" contenteditable="true">0</td>
                    `
    }
    //build html row with related data. (charge| velocity| velocity| velocity| moa| buttons)
    var row =  `
                <tr class="d-flex" scope="row" id="result-row-${result.pk}">
                  <td class="col" id="charge-${result.pk}" contenteditable="true">${result.charge}</td>`
                  +
                  velocityrow
                  +
                  `
                  <td class="col" id="moa-${result.pk}" contenteditable="true">${result.moa}</td>
                  <td class="col-3">
                    
                      <button class="btn btn-sm btn-danger" data-resultid=${result.pk} id="delete-${result.pk}">Delete</button>
                      <button class="btn btn-sm btn-info"  data-resultid=${result.pk} id="save-${result.pk}">Save</button>
                      
                      <button class="btn btn-sm btn-danger hidden" data-resultid=${result.pk} id="cancel-${result.pk}">Cancel</button>
                      <button class="btn btn-sm btn-primary hidden" data-resultid=${result.pk} id="confirm-${result.pk}">Confirm</button>
                    
                  </td>
                </tr>
    `
    $(`#bullet-table-${bullet_pk}`).append(row)

    $(`#delete-${result.pk}`).on('click', deleteResult)
    $(`#save-${result.pk}`).on('click', saveResult)
    $(`#cancel-${result.pk}`).on('click', cancelDeletion)
    $(`#confirm-${result.pk}`).on('click', confirmDeletion)  
  }

  //create a blank result and add it to the database
  function addResult(bullet_pk){ 
      url = `/api/data-create/${bullet_pk}/`
      fetch(url, {
				method:'POST',
				headers:{
					'Content-type':'application/json',
					'X-CSRFToken':csrftoken,
				},
			})
      .then(function(res){ return res.json(); })
      .then(function(data){ 
        addRow(data, bullet_pk) 
      })
      
  }

  //save the updated row when save button is pressed
  function saveResult(){ 
    //get the rusult id/pk
    var resultid = $(this ).data('resultid')
    //get each td for the row
    newresults = []
    $(`#result-row-${resultid} td`).each(function(){
      newresults.push($(this).html())
    })
    //pop button <td>
    newresults.pop()
    
    data = {'charge':newresults[0], 
            'moa':newresults[4], 
            'velocity':[
                {'velocity':newresults[1]}, 
                {'velocity':newresults[2]}, 
                {'velocity':newresults[3]},
            ]
          }
    
    url = `/api/data-update/${resultid}/`
    fetch(url, {
		  method:'PUT',
				headers:{
					'Content-type':'application/json',
					'X-CSRFToken':csrftoken,
				},
        body:JSON.stringify(data)
			}).then(function(response){
				console.log('test update')
			}) 
    
  }

  //toggles the buttons when delete is pressed to hide delete/save and show cancel/confirm
  function deleteResult(){
    var resultid = $(this).data('resultid')
    
    var deleteBtn = $(`#delete-${resultid}`)
    var saveBtn = $(`#save-${resultid}`)
    var cancelBtn = $(`#cancel-${resultid}`)
    var confirmBtn = $(`#confirm-${resultid}`)

    //toggle button visibilty
    deleteBtn.addClass('hidden')
    saveBtn.addClass('hidden')

    cancelBtn.removeClass('hidden')
    confirmBtn.removeClass('hidden')
  }


  function cancelDeletion(){
    var resultid = $(this).data('resultid')
    
    var deleteBtn = $(`#delete-${resultid}`)
    var saveBtn = $(`#save-${resultid}`)
    var cancelBtn = $(`#cancel-${resultid}`)
    var confirmBtn = $(`#confirm-${resultid}`)

    //toggle button visibilty
    deleteBtn.removeClass('hidden')
    saveBtn.removeClass('hidden')

    cancelBtn.addClass('hidden')
    confirmBtn.addClass('hidden')
  }

  function confirmDeletion(){
    var resultid = $(this).data('resultid')
    var row = $(`#result-row-${resultid}`)
    row.remove()  
    
    //deleteResult(data)
    var url = `/api/data-delete/${resultid}/`
    fetch(url, {
      method:'DELETE',
      headers:{
        'Content-type':'application/json',
        'X-CSRFToken':csrftoken,
      },
    }).then(function(response){
      console.log('test delete')
    })
  }

</script>
{% endblock scripts %}
